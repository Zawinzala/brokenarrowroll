<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êñ≠ÁÆ≠Á•û‰∫∫Âç°ÁªÑËÇâÈ∏Ω by Zola</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Core Palette */
            --bg-core: #050505;
            --bg-dark: #0b0c10;
            --bg-panel: rgba(31, 40, 51, 0.6);
            --bg-card: #141619;
            
            /* Accents */
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --text-highlight: #66fcf1;
            --border-color: rgba(102, 252, 241, 0.15);
            
            /* Teams */
            --team-a-main: #ff4757;
            --team-a-glow: rgba(255, 71, 87, 0.4);
            --team-b-main: #2ed573;
            --team-b-glow: rgba(46, 213, 115, 0.4);
            
            /* Effects */
            --gold: #ffa502;
            --purple: #a55eea; 
            --glass: rgba(11, 12, 16, 0.85);
            --shadow-card: 0 4px 6px rgba(0,0,0,0.3);
            
            /* Tag Colors */
            --tag-recon: #f1c40f;    
            --tag-infantry: #e17055; 
            --tag-tank: #ff6b81;     
            --tag-support: #0984e3;  
            --tag-helo: #00cec9;     
            --tag-air: #a29bfe;      
        }

        * { box-sizing: border-box; outline: none; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-core); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-highlight); }

        body {
            font-family: 'Noto Sans SC', 'Rajdhani', sans-serif;
            background-color: var(--bg-core);
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(102, 252, 241, 0.03) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(255, 71, 87, 0.03) 0%, transparent 25%);
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            padding-bottom: 40px;
        }

        /* --- Modern Header --- */
        .header-wrapper {
            width: 100%;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            padding: 20px 0 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        h1 {
            font-family: 'Rajdhani', sans-serif;
            font-size: clamp(1.8rem, 4vw, 3rem); /* Responsive Font Size */
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 6px;
            margin: 0;
            background: linear-gradient(90deg, var(--team-a-main), #fff, var(--team-b-main));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px rgba(255,255,255,0.15);
            text-align: center;
            line-height: 1.2;
        }

        #meta-info {
            font-size: 0.8rem;
            color: var(--text-sub);
            font-family: 'Rajdhani', monospace;
            opacity: 0.7;
        }

        /* --- Utility Bar (Top Buttons) --- */
        .top-utilities {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* --- Sticky Control Bar (Command Center) --- */
        .control-bar {
            width: 100%;
            max-width: 1400px;
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 20px;
            margin: 0 auto 20px auto;
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            position: sticky;
            top: 10px;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .config-section {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 15px;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .config-section:last-child { border-right: none; padding-right: 0; }
        
        .config-section-title {
            font-size: 0.8rem;
            color: var(--text-highlight);
            text-transform: uppercase;
            font-weight: 700;
            white-space: nowrap;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #ccc;
            background: rgba(0,0,0,0.2);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        select {
            background: #0b0c10;
            color: white;
            border: 1px solid #333;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-weight: bold;
            transition: all 0.2s;
        }
        select:hover, select:focus { border-color: var(--text-highlight); }

        /* Integrated Status Display */
        .status-display {
            flex: 1;
            text-align: center;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.95rem;
            color: var(--text-highlight);
            font-weight: 600;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(102, 252, 241, 0.1);
            border-radius: 4px;
            padding: 8px 15px;
            min-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            text-shadow: 0 0 5px rgba(102, 252, 241, 0.3);
        }
        .status-display.alert { color: var(--gold); border-color: rgba(255, 165, 2, 0.3); text-shadow: 0 0 5px rgba(255, 165, 2, 0.3); }

        /* Buttons */
        .btn {
            padding: 8px 20px; /* Slightly smaller padding for navbar fit */
            border: none;
            border-radius: 6px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #0b0c10;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            height: 38px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.5); filter: brightness(1.1); }
        .btn:active { transform: translateY(0); }

        .btn-upload { background: #34495e; color: #ecf0f1; border: 1px solid rgba(255,255,255,0.1); }
        .btn-blue { background: linear-gradient(135deg, #2c3e50, #45a29e); color: white; border: 1px solid #45a29e; }
        .btn-gold { background: linear-gradient(135deg, #f1c40f, #ff9f43); color: #2d3436; }
        .btn-red { background: linear-gradient(135deg, #c0392b, #ff4757); color: white; }

        /* --- Game Container & Layout --- */
        .page-container {
            width: 100%;
            max-width: 1600px;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .game-phase {
            display: none; 
            flex-direction: column;
            gap: 40px;
            animation: fadeIn 0.5s ease-out;
        }
        .game-phase.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Global Board (Phase 1) --- */
        .global-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            width: 100%;
        }

        .global-team-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }
        .global-team-panel::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
        }
        .global-team-panel.a::before { background: var(--team-a-main); box-shadow: 0 0 15px var(--team-a-main); }
        .global-team-panel.b::before { background: var(--team-b-main); box-shadow: 0 0 15px var(--team-b-main); }

        .global-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 20px 0 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
            color: var(--text-main);
            letter-spacing: 1px;
        }

        .req-badge {
            font-size: 0.8rem;
            padding: 3px 10px;
            border-radius: 12px;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            transition: 0.3s;
        }
        .req-badge.valid { background: var(--gold); color: #000; border-color: var(--gold); box-shadow: 0 0 10px rgba(255, 165, 2, 0.4); }

        /* --- Card Grid System --- */
        .global-cards-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            min-height: 100px;
            padding: 5px;
        }
        
        /* 
           Fixed for Requirement 4 & 2: 
           Allows 5 cards to fit on one line on desktop by reducing min-width slightly and reducing gap.
           Font size remains unchanged.
        */
        .hand-container {
            display: grid;
            /* 120px is small enough to fit 5 in ~650px width, large enough for text */
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 10px; 
            padding: 10px;
            flex: 1;
        }

        /* --- Arena (Phase 2) --- */
        .arena {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            width: 100%;
        }

        .team-header {
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            padding-bottom: 15px;
            border-bottom: 2px solid;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            letter-spacing: 2px;
        }
        
        .team-a .team-header { color: var(--team-a-main); border-color: var(--team-a-main); justify-content: flex-start; text-shadow: 0 0 15px rgba(255, 71, 87, 0.3); }
        .team-b .team-header { color: var(--team-b-main); border-color: var(--team-b-main); justify-content: flex-end; text-shadow: 0 0 15px rgba(46, 213, 115, 0.3); }

        .player-panel {
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            display: flex;
            margin-bottom: 20px;
            position: relative;
            transition: border-color 0.3s;
        }
        .player-panel:hover { border-color: rgba(255,255,255,0.15); }

        .team-a .player-panel { border-left: 4px solid var(--team-a-main); }
        .team-b .player-panel { border-right: 4px solid var(--team-b-main); flex-direction: row-reverse; }

        .player-meta {
            width: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.25);
            flex-shrink: 0;
            padding: 10px;
        }
        
        .team-a .player-meta { border-radius: 8px 0 0 8px; border-right: 1px solid rgba(255,255,255,0.05); }
        .team-b .player-meta { border-radius: 0 8px 8px 0; border-left: 1px solid rgba(255,255,255,0.05); }

        .player-id { font-size: 1.4rem; font-weight: 800; font-family: 'Rajdhani'; color: #fff; }

        /* AI Name Tag */
        .ai-combo-name {
            position: absolute;
            top: -12px; left: 100px; z-index: 10;
            background: #000; padding: 2px 12px;
            border: 1px solid; border-radius: 4px;
            font-size: 0.85rem; font-weight: 900; font-style: italic;
            text-transform: uppercase; white-space: nowrap;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
            opacity: 0; display: none;
            pointer-events: none;
        }
        .team-b .ai-combo-name { left: auto; right: 100px; }
        .team-a .ai-combo-name { color: var(--team-a-main); border-color: var(--team-a-main); }
        .team-b .ai-combo-name { color: var(--team-b-main); border-color: var(--team-b-main); }
        .ai-combo-name.active { display: block; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.5) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .pick-counter { margin-top: 8px; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: #222; color: #777; font-weight: 600; }
        .pick-counter.done { color: #000; background: var(--gold); box-shadow: 0 0 8px rgba(255, 165, 2, 0.5); }

        /* --- Cards --- */
        .card {
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 110px; /* Base height */
            transition: all 0.25s ease;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            border-color: var(--text-highlight);
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            background: #1e2126;
            z-index: 2;
        }

        .card.selected {
            border: 2px solid var(--gold);
            background: #252525;
            box-shadow: 0 0 20px rgba(255, 211, 42, 0.2);
            transform: translateY(-2px);
        }
        
        .card.type-buff { border-top: 3px solid var(--gold); }
        .card.type-debuff { border-top: 3px solid var(--purple); }
        .card.type-unit { border-top: 3px solid var(--text-highlight); }

        .card-title {
            font-size: 0.85rem; font-weight: 700; color: #fff;
            margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .card-desc {
            font-size: 0.7rem; color: #999; line-height: 1.3;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }
        
        /* Neon Tags on Card */
        .card-tag {
            position: absolute; bottom: 6px; right: 8px;
            font-size: 0.65rem; font-weight: 900; text-transform: uppercase;
            opacity: 0.8; letter-spacing: 0.5px;
        }
        .tag-recon { color: var(--tag-recon); }
        .tag-infantry { color: var(--tag-infantry); }
        .tag-tank { color: var(--tag-tank); }
        .tag-support { color: var(--tag-support); }
        .tag-helo { color: var(--tag-helo); }
        .tag-air { color: var(--tag-air); }

        /* --- Tooltip --- */
        #tooltip {
            position: fixed; background: rgba(15, 18, 25, 0.98); border: 1px solid var(--text-highlight);
            box-shadow: 0 15px 40px rgba(0,0,0,1); padding: 15px; border-radius: 8px; width: 320px;
            pointer-events: none; opacity: 0; transform: scale(0.95); z-index: 9999; color: #fff;
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        #tooltip.visible { opacity: 1; transform: scale(1); }
        #tooltip h4 { margin: 0 0 10px 0; color: var(--text-highlight); border-bottom: 1px solid #333; padding-bottom: 8px; font-size: 1.1rem; }
        #tooltip p { margin: 0 0 12px 0; font-size: 0.95rem; color: #dcdcdc; line-height: 1.5; }
        .tooltip-author { text-align: right; font-size: 0.8rem; color: var(--gold); font-style: italic; opacity: 0.8; }

        input[type="file"] { display: none; }

        /* --- Side Search --- */
        .side-search-button {
            position: fixed; left: 20px; bottom: 20px; z-index: 1200;
            background: linear-gradient(135deg, var(--text-highlight), #2ed573);
            color: #0b0c10; width: 50px; height: 50px;
            border-radius: 50%; border: none; font-size: 1.5rem;
            box-shadow: 0 5px 20px rgba(102, 252, 241, 0.4);
            cursor: pointer; transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .side-search-button:hover { transform: scale(1.1) rotate(15deg); }

        .search-panel {
            position: fixed; left: 20px; bottom: 80px; width: 360px; max-height: 60vh;
            background: rgba(11, 12, 16, 0.95); border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(20px); border-radius: 12px; padding: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); z-index: 1600;
            display: flex; flex-direction: column; gap: 10px;
            transform: translateX(-120%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .search-panel.active { transform: translateX(0); }
        .search-panel input {
            width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #333;
            background: rgba(0,0,0,0.3); color: white;
        }
        .search-result {
            padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px;
            border: 1px solid transparent; cursor: pointer; transition: 0.2s;
            position: relative;
        }
        .search-result:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }
        .search-results-container { overflow-y: auto; max-height: 400px; display: flex; flex-direction: column; gap: 8px; }

        /* --- Mobile Responsive --- */
        @media (max-width: 960px) {
            .arena { grid-template-columns: 1fr; gap: 20px; }
            .team-b .player-panel { flex-direction: row; border-right: none; border-left: 4px solid var(--team-b-main); }
            .team-b .player-meta { border-radius: 8px 0 0 8px; border-left: none; border-right: 1px solid rgba(255,255,255,0.05); }
            .team-b .team-header { flex-direction: row; justify-content: flex-start; }
            .ai-combo-name { left: 100px; right: auto; }
            .global-board { grid-template-columns: 1fr; }
        }

        @media (max-width: 600px) {
            .control-bar { flex-direction: column; align-items: stretch; gap: 15px; padding: 15px; }
            .config-section { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; padding-right: 0; width: 100%; justify-content: space-between; }
            .config-section:last-child { border-bottom: none; }
            .player-panel { flex-direction: column; }
            .player-meta { width: 100%; flex-direction: row; justify-content: space-between; border-radius: 8px 8px 0 0; padding: 5px 15px; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.05); }
            .card { height: 100px; }
            .side-search-button { bottom: 10px; left: auto; right: 10px; }
            .search-panel { left: 10px; right: 10px; bottom: 70px; width: auto; }
            /* Mobile fallback for hand */
            .hand-container { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
            .status-display { min-width: auto; margin-top: 5px; }
        }

        /* --- Showdown Mode Overrides --- */
        .mode-showdown .card:not(.selected) { display: none !important; }
        .mode-showdown .global-cards-row .card:not(.selected) { display: none !important; }
        .mode-showdown .card.selected { 
            width: 100%; height: auto; min-height: 120px; transform: none !important; cursor: default;
            grid-column: span 1; 
        }
        .mode-showdown .global-cards-row, .mode-showdown .hand-container { 
            display: flex; flex-wrap: wrap; gap: 15px; 
        }
        .mode-showdown .card.selected { flex: 1 1 200px; }
    </style>
</head>
<body>

    <div id="tooltip">
        <h4>Title</h4>
        <p>Content</p>
        <div class="tooltip-author">Author</div>
    </div>

    <!-- Header Section -->
    <div class="header-wrapper">
        <h1>Êñ≠ÁÆ≠Á•û‰∫∫Âç°ÁªÑËÇâÈ∏Ω by zola</h1>
        <div id="meta-info">DATA VERSION: WAITING FOR LOAD...</div>
    </div>

    <div class="page-container">
        
        <!-- Utility Buttons -->
        <div class="top-utilities" id="top-utilities">
            <label class="btn btn-upload">
                <span style="font-size: 1.2em;">üìÇ</span> Âä†ËΩΩ JSON
                <input type="file" id="fileInput" accept=".json">
            </label>

            <a href="https://github.com/Zawinzala/brokenarrowroll" target="_blank" class="btn btn-upload" style="background: #24292e;">
                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.6.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.087-.744.084-.689.084-.689 1.205.084 1.839 1.237 1.839 1.237 1.07 1.836 2.809 1.305 3.495.998.108-.77.419-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.118-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.652.242 2.873.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.8.576 4.757-1.589 8.199-6.086 8.199-11.385 0-6.627-5.373-12-12-12z"/></svg>
                GitHub Ê∫êÁ†Å
            </a>

            <button class="btn btn-upload" id="btn-feedback">üìß ÂèçÈ¶àËØçÊù°</button>
            <button class="btn btn-red" id="btn-restart" style="display:none;">üîÑ ÈáçÊñ∞ÂºÄÂßã</button>
        </div>

        <!-- Sticky Control Bar -->
        <div class="control-bar" role="navigation">
            <!-- Global Phase Controls -->
            <div id="global-controls" style="display:none; gap:15px; align-items:center; flex-wrap:wrap; width:100%;">
                <div class="config-section">
                    <div class="config-section-title">ÂÖ®Â±Ä Buff</div>
                    <div class="setting-group">
                        <span>Roll:</span>
                        <select id="buffRollSelect">
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <span>Pick:</span>
                        <select id="buffPickSelect">
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Êú¨Èòü Debuff</div>
                    <div class="setting-group">
                        <span>Roll:</span>
                        <select id="debuffRollSelect">
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <span>Pick:</span>
                        <select id="debuffPickSelect">
                            <option value="1">1</option>
                            <option value="2" selected>2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>
                
                <!-- Fixed: Phase 1 Button logic inside the container -->
                <div style="flex:1;"></div> 
                <button class="btn btn-blue btn-phase" id="btn-start-global" style="display:flex;">1Ô∏è‚É£ ÊäΩÂèñÂÖ®Â±Ä</button>
                <button class="btn btn-gold btn-phase" id="btn-confirm-global" style="display:none;">‚úÖ ËøõÂÖ•Èò∂ÊÆµ‰∫å</button>
            </div>

            <!-- Unit Phase Controls -->
            <div id="unit-controls" style="display:none; gap:15px; align-items:center; flex-wrap:wrap; width:100%;">
                <div class="config-section">
                    <div class="config-section-title">ÂØπÊàòËÆæÁΩÆ</div>
                    <div class="setting-group">
                        <span>‰∫∫Êï∞:</span>
                        <select id="playerCountSelect">
                            <option value="1">1v1</option>
                            <option value="2">2v2</option>
                            <option value="3">3v3</option>
                            <option value="4">4v4</option>
                            <option value="5" selected>5v5</option>
                        </select>
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">ÈòüÂëòÈÉ®ÁΩ≤</div>
                    <div class="setting-group">
                        <span>Roll:</span>
                        <select id="rollCountSelect">
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>

                    <div class="setting-group">
                        <span>Pick:</span>
                        <select id="pickCountSelect">
                            <option value="1">1</option>
                            <option value="2" selected>2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>

                <div style="flex:1;"></div> 
                <button class="btn btn-blue" id="btn-roll-units">üé≤ ÈÉ®ÁΩ≤ÈòüÂëò</button>
                <button class="btn btn-gold" id="btn-showdown" style="display:none;">‚öîÔ∏è ÊúÄÁªàÂÜ≥Êàò</button>
            </div>

            <!-- Fixed: Merged Status Display -->
            <div id="integrated-status" class="status-display">Á≠âÂæÖÊï∞ÊçÆÂä†ËΩΩ...</div>
        </div>
        
        <!-- Old Status Bar Removed -->

        <!-- Phase 1: Global -->
        <div id="phase-global" class="game-phase">
            <div class="global-board">
                <div class="global-team-panel a">
                    <div class="team-header" style="font-size:1.5rem; border-bottom:none;">Team Alpha (Global)</div>
                    
                    <div class="global-section-title">
                        <span id="label-a-buff">ÂÖ®Â±Ä Buff</span>
                        <span class="req-badge" id="badge-a-buff">0/0</span>
                    </div>
                    <div class="global-cards-row" id="row-a-buff"></div>

                    <div class="global-section-title">
                        <span id="label-a-debuff">Êú¨Èòü Debuff</span>
                        <span class="req-badge" id="badge-a-debuff">0/0</span>
                    </div>
                    <div class="global-cards-row" id="row-a-debuff"></div>
                </div>

                <div class="global-team-panel b">
                    <div class="team-header" style="font-size:1.5rem; border-bottom:none;">Team Bravo (Global)</div>
                    
                    <div class="global-section-title">
                        <span id="label-b-buff">ÂÖ®Â±Ä Buff</span>
                        <span class="req-badge" id="badge-b-buff">0/0</span>
                    </div>
                    <div class="global-cards-row" id="row-b-buff"></div>

                    <div class="global-section-title">
                        <span id="label-b-debuff">Êú¨Èòü Debuff</span>
                        <span class="req-badge" id="badge-b-debuff">0/0</span>
                    </div>
                    <div class="global-cards-row" id="row-b-debuff"></div>
                </div>
            </div>
        </div>

        <!-- Phase 2: Units -->
        <div id="phase-units" class="game-phase">
            <div class="arena">
                <div class="team-col team-a" id="col-a">
                    <div class="team-header">Alpha Team</div>
                    <div id="roster-a"></div>
                </div>

                <div class="team-col team-b" id="col-b">
                    <div class="team-header">Bravo Team</div>
                    <div id="roster-b"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Side Search -->
    <button class="side-search-button" id="sideSearchBtn">üîç</button>

    <div class="search-panel" id="searchPanel" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <strong style="color:var(--text-highlight);">ËØçÊù°ÊêúÁ¥¢</strong>
            <button class="btn btn-upload" id="closeSearch" style="padding:4px 10px; font-size:0.8rem;">ÂÖ≥Èó≠</button>
        </div>
        <input type="search" id="searchInput" placeholder="ÊêúÁ¥¢ÂÖ≥ÈîÆËØç..." />
        <div class="search-results-container" id="searchResults"></div>
    </div>

    <script>
        // --- Configuration ---
        const UNIT_CATEGORIES = ['recon', 'infantry', 'tank', 'support', 'helo', 'air'];
        
        // --- State ---
        let RAW_DATA = {};
        let POOLS = {
            buffs: [],
            debuffs: [],
            byCategory: {
                recon: [], infantry: [], tank: [], support: [], helo: [], air: []
            }
        };
        
        let GLOBAL_CONFIG = { buff: {roll:3, pick:1}, debuff: {roll:3, pick:2} };
        let GLOBAL_SELECTIONS = {
            a: { buffs: new Set(), debuffs: new Set() },
            b: { buffs: new Set(), debuffs: new Set() }
        };
        
        let PLAYER_DATA = { a: [], b: [] };
        let PICK_SETTINGS = { roll: 3, pick: 2 }; 
        const AI_API_KEY = "sk-PFqiLSA0iusyRDuYAe74CfFdD0D0457094176d6b2451Ee57";
        const AI_BASE_URL = "https://aihubmix.com/v1/chat/completions";

        // --- DOM Elements ---
        const dom = {
            fileInput: document.getElementById('fileInput'),
            status: document.getElementById('integrated-status'), // UPDATED to new ID
            tooltip: document.getElementById('tooltip'),
            metaInfo: document.getElementById('meta-info'),
            
            globalControls: document.getElementById('global-controls'),
            unitControls: document.getElementById('unit-controls'),
            phaseGlobal: document.getElementById('phase-global'),
            phaseUnits: document.getElementById('phase-units'),
            
            btnStartGlobal: document.getElementById('btn-start-global'),
            btnConfirmGlobal: document.getElementById('btn-confirm-global'),
            btnRollUnits: document.getElementById('btn-roll-units'),
            btnShowdown: document.getElementById('btn-showdown'),
            btnRestart: document.getElementById('btn-restart'),
            
            selBuffRoll: document.getElementById('buffRollSelect'),
            selBuffPick: document.getElementById('buffPickSelect'),
            selDebuffRoll: document.getElementById('debuffRollSelect'),
            selDebuffPick: document.getElementById('debuffPickSelect'),
            selRoll: document.getElementById('rollCountSelect'),
            selPick: document.getElementById('pickCountSelect'),
            selPlayerCount: document.getElementById('playerCountSelect'),

            rosterA: document.getElementById('roster-a'),
            rosterB: document.getElementById('roster-b'),
            rowABuff: document.getElementById('row-a-buff'),
            rowADebuff: document.getElementById('row-a-debuff'),
            rowBBuff: document.getElementById('row-b-buff'),
            rowBDebuff: document.getElementById('row-b-debuff'),
            badgeABuff: document.getElementById('badge-a-buff'),
            badgeADebuff: document.getElementById('badge-a-debuff'),
            badgeBBuff: document.getElementById('badge-b-buff'),
            badgeBDebuff: document.getElementById('badge-b-debuff')
        };

        /* --- 1. Init --- */
        dom.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    RAW_DATA = JSON.parse(evt.target.result);
                    processData(RAW_DATA);
                    updateStatus(`Êï∞ÊçÆÂä†ËΩΩÊàêÂäü: ${file.name}`);
                } catch (err) {
                    console.error(err);
                    alert("JSON Ê†ºÂºèÈîôËØØ");
                }
            };
            reader.readAsText(file);
        });

        function updateStatus(text, isAlert = false) {
            dom.status.textContent = text;
            if (isAlert) dom.status.classList.add('alert');
            else dom.status.classList.remove('alert');
        }

        function processData(data) {
            const debuffField = data.global_debuffs || data.team_debuffs;
            
            if (!data.global_buffs || !debuffField) {
                alert("JSON Áº∫Â∞ë global_buffs Êàñ global_debuffs/team_debuffs Â≠óÊÆµÔºÅ");
                return;
            }

            POOLS.buffs = data.global_buffs.map(c => ({...c, type: 'buff', uid: Math.random(), author: c.author || 'Êú™Áü•'}));
            POOLS.debuffs = debuffField.map(c => ({...c, type: 'debuff', uid: Math.random(), author: c.author || 'Êú™Áü•'}));

            let totalUnits = 0;
            UNIT_CATEGORIES.forEach(cat => {
                POOLS.byCategory[cat] = [];
                if (data[cat] && Array.isArray(data[cat])) {
                    data[cat].forEach(card => {
                        POOLS.byCategory[cat].push({
                            ...card,
                            type: 'unit',
                            category: cat,
                            uid: Math.random(),
                            author: card.author || 'Êú™Áü•'
                        });
                        totalUnits++;
                    });
                }
            });

            if (totalUnits < 20) {
                updateStatus(`Ë≠¶ÂëäÔºöÈÉ®ÈòüÊ±†ËøáÂ∞è (${totalUnits} Âº†)`, true);
            } else {
                updateStatus(`Êï∞ÊçÆÂ∞±Áª™! Buff:${POOLS.buffs.length}, Units:${totalUnits}`);
            }

            if (data.metadata) {
                let metaStr = '';
                if (data.metadata.version) metaStr += `JSON v${data.metadata.version}`;
                if (data.metadata.last_updated) {
                    if (metaStr) metaStr += ' | ';
                    metaStr += `${data.metadata.last_updated}`;
                }
                dom.metaInfo.textContent = metaStr;
            } else {
                dom.metaInfo.textContent = "Data Version: Unknown";
            }

            dom.globalControls.style.display = 'flex';
            dom.btnRestart.style.display = 'block';
        }
        
        async function attemptAutoLoad(filename = 'deck_config.json') {
            updateStatus(`Âä†ËΩΩ‰∏≠... ${filename}`);
            try {
                const response = await fetch(filename);
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                const data = await response.json();
                RAW_DATA = data;
                processData(RAW_DATA);
                updateStatus(`ÈÖçÁΩÆÂä†ËΩΩÊàêÂäü: ${filename}`);
            } catch (error) {
                console.warn(error.message);
                dom.fileInput.parentElement.style.display = 'flex'; 
                updateStatus(`ËØ∑ÊâãÂä®Âä†ËΩΩ JSON Êñá‰ª∂`, true);
            }
        }

        /* --- 2. Global Phase --- */
        dom.btnStartGlobal.addEventListener('click', () => {
            const br = parseInt(dom.selBuffRoll.value);
            const bp = parseInt(dom.selBuffPick.value);
            const dr = parseInt(dom.selDebuffRoll.value);
            const dp = parseInt(dom.selDebuffPick.value);

            if (br < bp || dr < dp) {
                alert("Roll Êï∞ÂøÖÈ°ªÂ§ß‰∫éÁ≠â‰∫é Pick Êï∞");
                return;
            }

            GLOBAL_CONFIG = { buff: {roll: br, pick: bp}, debuff: {roll: dr, pick: dp} };

            GLOBAL_SELECTIONS = {
                a: { buffs: new Set(), debuffs: new Set() },
                b: { buffs: new Set(), debuffs: new Set() }
            };

            ['a', 'b'].forEach(t => {
                document.getElementById(`label-${t}-buff`).textContent = `ÂÖ®Â±Ä Buff (${br}ÈÄâ${bp})`;
                document.getElementById(`label-${t}-debuff`).textContent = `Êú¨Èòü Debuff (${dr}ÈÄâ${dp})`;
            });

            dom.btnStartGlobal.textContent = "üîÑ ÈáçÊñ∞ÊäΩÂèñ";
            dom.phaseGlobal.classList.add('active');
            
            renderGlobalSection('a');
            renderGlobalSection('b');
            
            updateStatus("Èò∂ÊÆµ‰∏ÄÔºöÁÇπÂáªÂç°ÁâåËøõË°åÈÄâÊã©");
            updateGlobalStatus();
        });

        function renderGlobalSection(team) {
            const buffs = getRandom(POOLS.buffs, GLOBAL_CONFIG.buff.roll);
            renderCards(buffs, team === 'a' ? dom.rowABuff : dom.rowBBuff, team, 'buff');

            const debuffs = getRandom(POOLS.debuffs, GLOBAL_CONFIG.debuff.roll);
            renderCards(debuffs, team === 'a' ? dom.rowADebuff : dom.rowBDebuff, team, 'debuff');
        }

        function renderCards(cards, container, team, type) {
            container.innerHTML = '';
            cards.forEach((card, index) => {
                const el = createCardElement(card);
                el.addEventListener('click', () => toggleGlobalSelection(el, card, team, type));
                container.appendChild(el);
            });
        }

        function toggleGlobalSelection(el, card, team, type) {
            const set = GLOBAL_SELECTIONS[team][type + 's'];
            const limit = GLOBAL_CONFIG[type].pick;

            if (set.has(card.uid)) {
                set.delete(card.uid);
                el.classList.remove('selected');
            } else {
                if (set.size >= limit) {
                    // Shake animation
                    el.animate([{ transform: 'translateX(-4px)' }, { transform: 'translateX(4px)' }, { transform: 'translateX(0)' }], { duration: 200 });
                    return;
                }
                set.add(card.uid);
                el.classList.add('selected');
            }
            updateGlobalStatus();
        }

        function updateGlobalStatus() {
            const aBuff = GLOBAL_SELECTIONS.a.buffs.size;
            const aDebuff = GLOBAL_SELECTIONS.a.debuffs.size;
            const bBuff = GLOBAL_SELECTIONS.b.buffs.size;
            const bDebuff = GLOBAL_SELECTIONS.b.debuffs.size;

            const maxBuff = GLOBAL_CONFIG.buff.pick;
            const maxDebuff = GLOBAL_CONFIG.debuff.pick;

            updateBadge(dom.badgeABuff, aBuff, maxBuff);
            updateBadge(dom.badgeADebuff, aDebuff, maxDebuff);
            updateBadge(dom.badgeBBuff, bBuff, maxBuff);
            updateBadge(dom.badgeBDebuff, bDebuff, maxDebuff);

            if (aBuff===maxBuff && aDebuff===maxDebuff && bBuff===maxBuff && bDebuff===maxDebuff) {
                dom.btnConfirmGlobal.style.display = 'flex';
                updateStatus("ÈÄâÊã©ÂÆåÊàêÔºåËØ∑ÁÇπÂáªÁ°ÆËÆ§", true);
            } else {
                dom.btnConfirmGlobal.style.display = 'none';
                updateStatus("Èò∂ÊÆµ‰∏ÄÔºöÁÇπÂáªÂç°ÁâåËøõË°åÈÄâÊã©");
            }
        }

        function updateBadge(el, current, max) {
            el.textContent = `${current}/${max}`;
            if (current === max) el.classList.add('valid');
            else el.classList.remove('valid');
        }

        dom.btnConfirmGlobal.addEventListener('click', () => {
            dom.btnConfirmGlobal.style.display = 'none';
            dom.globalControls.style.display = 'none'; 
            dom.unitControls.style.display = 'flex';
            dom.phaseUnits.classList.add('active');
            updateStatus("Èò∂ÊÆµ‰∫åÔºöÈÖçÁΩÆ‰∫∫Êï∞ÔºåÁîüÊàêÈÉ®Èòü");
            
            // Smooth scroll to units
            setTimeout(() => {
                dom.phaseUnits.scrollIntoView({behavior: 'smooth', block: 'start'});
            }, 100);
        });

        /* --- 3. Unit Phase --- */
        dom.btnRollUnits.addEventListener('click', () => {
            const rollCount = parseInt(dom.selRoll.value);
            const pickCount = parseInt(dom.selPick.value);
            const playersPerTeam = parseInt(dom.selPlayerCount.value);

            if (rollCount < pickCount) {
                alert("Roll Êï∞ÂøÖÈ°ªÂ§ß‰∫éÁ≠â‰∫é Pick Êï∞");
                return;
            }
            if (rollCount > UNIT_CATEGORIES.length) {
                 alert(`Roll Êï∞ (${rollCount}) ‰∏çËÉΩË∂ÖËøáÁé∞ÊúâÂÖµÁßçÊ†èÁõÆÊÄªÊï∞ (${UNIT_CATEGORIES.length})`);
                 return;
            }

            PICK_SETTINGS = { roll: rollCount, pick: pickCount };

            let currentDeck = {};
            UNIT_CATEGORIES.forEach(cat => {
                currentDeck[cat] = [...POOLS.byCategory[cat]].sort(() => 0.5 - Math.random());
            });

            let errorMsg = null;

            ['a', 'b'].forEach(team => {
                PLAYER_DATA[team] = [];
                for (let i=0; i<playersPerTeam; i++) {
                    let availableCats = [...UNIT_CATEGORIES].sort(() => 0.5 - Math.random());
                    let selectedCats = availableCats.slice(0, rollCount);
                    let hand = [];
                    
                    selectedCats.forEach(cat => {
                        if (currentDeck[cat].length > 0) {
                            hand.push(currentDeck[cat].pop());
                        } else {
                            errorMsg = `ÈîôËØØÔºö${cat} Ê†èÁõÆÂç°Áâå‰∏çË∂≥ÔºÅ`;
                        }
                    });

                    PLAYER_DATA[team].push({
                        id: `${team}${i}`,
                        hand: hand,
                        picks: new Set()
                    });
                }
            });

            if (errorMsg) {
                alert(errorMsg);
                return;
            }

            renderPlayerRosters();
            dom.btnRollUnits.textContent = "üîÑ ÈáçÊñ∞ÁîüÊàê";
            updateStatus("ËØ∑ÂêÑÈòüÂëòÁÇπÂáªÂç°ÁâåËøõË°åÈÄâÊã©");
            checkUnitReadiness();
        });

        function renderPlayerRosters() {
            ['a', 'b'].forEach(team => {
                const container = team === 'a' ? dom.rosterA : dom.rosterB;
                container.innerHTML = '';

                PLAYER_DATA[team].forEach((p, idx) => {
                    const panel = document.createElement('div');
                    panel.className = 'player-panel';
                    
                    const meta = document.createElement('div');
                    meta.className = 'player-meta';
                    meta.innerHTML = `<div class="player-id">${team.toUpperCase()}${idx+1}</div><div class="pick-counter" id="cnt-${team}-${idx}">0/${PICK_SETTINGS.pick}</div>`;
                    
                    const aiLabel = document.createElement('div');
                    aiLabel.className = 'ai-combo-name';
                    aiLabel.id = `ai-${team}-${idx}`;

                    const handDiv = document.createElement('div');
                    handDiv.className = 'hand-container';

                    p.hand.forEach((card, cIdx) => {
                        const cardEl = createCardElement(card);
                        cardEl.dataset.uid = card.uid;
                        cardEl.addEventListener('click', () => handleUnitPick(team, idx, card.uid, cardEl));
                        handDiv.appendChild(cardEl);
                    });

                    panel.appendChild(meta);
                    panel.appendChild(aiLabel);
                    panel.appendChild(handDiv);
                    container.appendChild(panel);
                });
            });
        }

        function handleUnitPick(team, pIdx, uid, el) {
            const player = PLAYER_DATA[team][pIdx];
            
            if (player.picks.has(uid)) {
                player.picks.delete(uid);
                el.classList.remove('selected');
            } else {
                if (player.picks.size >= PICK_SETTINGS.pick) {
                     el.animate([{ transform: 'translateX(-4px)' }, { transform: 'translateX(4px)' }, { transform: 'translateX(0)' }], { duration: 150 });
                    return;
                }
                player.picks.add(uid);
                el.classList.add('selected');
            }

            const cnt = document.getElementById(`cnt-${team}-${pIdx}`);
            cnt.textContent = `${player.picks.size}/${PICK_SETTINGS.pick}`;
            cnt.classList.toggle('done', player.picks.size === PICK_SETTINGS.pick);

            checkUnitReadiness();
        }

        function checkUnitReadiness() {
            let pending = false;
            ['a', 'b'].forEach(t => {
                PLAYER_DATA[t].forEach(p => {
                    if (p.picks.size < PICK_SETTINGS.pick) pending = true;
                });
            });

            if (!pending && PLAYER_DATA.a.length > 0) {
                dom.btnShowdown.style.display = 'flex';
                updateStatus("ÂÖ®ÂëòÂ∞±Áª™ÔºÅÁÇπÂáªËøõÂÖ•ÊúÄÁªàÂÜ≥Êàò", true);
            } else {
                dom.btnShowdown.style.display = 'none';
                updateStatus("Á≠âÂæÖÈòüÂëòÈÄâÊã©...");
            }
        }

        /* --- 4. Showdown --- */
        dom.btnShowdown.addEventListener('click', () => {
            document.body.classList.add('mode-showdown');
            dom.unitControls.style.display = 'none';
            updateStatus("‚öîÔ∏è BATTLE PHASE ‚öîÔ∏è", true);
            triggerAIGeneration();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        /* --- 5. Restart --- */
        dom.btnRestart.addEventListener('click', () => {
            if(!confirm("Á°ÆÂÆöË¶ÅÈáçÊñ∞ÂºÄÂßãÂêóÔºüÂΩìÂâçËøõÂ∫¶Â∞Ü‰∏¢Â§±„ÄÇ")) return;
            
            document.body.classList.remove('mode-showdown');
            dom.phaseGlobal.classList.remove('active');
            dom.phaseUnits.classList.remove('active');
            
            dom.globalControls.style.display = 'flex';
            dom.unitControls.style.display = 'none';
            dom.btnConfirmGlobal.style.display = 'none';
            dom.btnShowdown.style.display = 'none';
            dom.btnStartGlobal.textContent = "1Ô∏è‚É£ ÊäΩÂèñÂÖ®Â±Ä";

            dom.rowABuff.innerHTML = ''; dom.rowADebuff.innerHTML = '';
            dom.rowBBuff.innerHTML = ''; dom.rowBDebuff.innerHTML = '';
            dom.rosterA.innerHTML = ''; dom.rosterB.innerHTML = '';

            updateBadge(dom.badgeABuff, 0, 0); updateBadge(dom.badgeADebuff, 0, 0);
            updateBadge(dom.badgeBBuff, 0, 0); updateBadge(dom.badgeBDebuff, 0, 0);

            GLOBAL_SELECTIONS = { a: { buffs: new Set(), debuffs: new Set() }, b: { buffs: new Set(), debuffs: new Set() } };
            PLAYER_DATA = { a: [], b: [] };
            
            updateStatus("Â∑≤ÈáçÁΩÆ„ÄÇËØ∑ÊäΩÂèñÂÖ®Â±ÄËØçÊù°");
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        /* --- Helpers --- */
        function createCardElement(card) {
            const el = document.createElement('div');
            el.className = `card type-${card.type}`;
            const tagClass = card.category ? `tag-${card.category}` : '';
            
            el.innerHTML = `
                <div class="card-title">${card.title || 'Êú™Áü•'}</div>
                <div class="card-desc">${card.content || '...'}</div>
                ${card.category ? `<div class="card-tag ${tagClass}">${card.category}</div>` : ''}
            `;
            el.addEventListener('mouseenter', (e) => showTooltip(e, card));
            el.addEventListener('mousemove', moveTooltip);
            el.addEventListener('mouseleave', hideTooltip);
            return el;
        }

        function getRandom(arr, n) {
            const shuffled = [...arr].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, n);
        }

        function showTooltip(e, card) {
            dom.tooltip.innerHTML = `
                <h4>${card.title}</h4>
                <p>${card.content}</p>
                <div class="tooltip-author">¬© ${card.author || 'Êú™Áü•‰ΩúËÄÖ'}</div>
            `;
            dom.tooltip.classList.add('visible');
            moveTooltip(e);
        }
        function moveTooltip(e) {
            const x = e.clientX + 15;
            const y = e.clientY + 15;
            const rect = dom.tooltip.getBoundingClientRect();
            let left = x;
            let top = y;
            // Prevent tooltip from going off-screen
            if (left + rect.width > window.innerWidth) left = window.innerWidth - rect.width - 20;
            if (top + rect.height > window.innerHeight) top = e.clientY - rect.height - 20;
            
            dom.tooltip.style.left = left + 'px';
            dom.tooltip.style.top = top + 'px';
        }
        function hideTooltip() { dom.tooltip.classList.remove('visible'); }

        async function triggerAIGeneration() {
            ['a', 'b'].forEach(team => {
                PLAYER_DATA[team].forEach(async (player, idx) => {
                    const titles = [];
                    player.hand.forEach(c => {
                        if (player.picks.has(c.uid)) titles.push(c.title);
                    });
                    if (titles.length === 0) return;
                    const name = await fetchAIName(titles);
                    if (name) {
                        const label = document.getElementById(`ai-${team}-${idx}`);
                        label.textContent = name;
                        label.classList.add('active');
                    }
                });
            });
        }

        async function fetchAIName(titles) {
            const prompt = `Áé∞ÊúâÂç°ÁâåÊäÄËÉΩÔºö[${titles.join(',')}]„ÄÇËØ∑Ëµ∑‰∏Ä‰∏™Èú∏Ê∞îÊàñÊêûÁ¨ëÁöÑ‰∏≠‰∫åÁªÑÂêàÂêçÔºà4-6Â≠óÔºâ„ÄÇÂè™ËøîÂõûÂêçÂ≠ó„ÄÇ`;
            try {
                const res = await fetch(AI_BASE_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${AI_API_KEY}` },
                    body: JSON.stringify({
                        model: "sophnet-deepseek-v3.2",
                        messages: [{"role":"user", "content": prompt}]
                    })
                });
                const data = await res.json();
                return data.choices?.[0]?.message?.content?.replace(/["'„ÄÇ]/g, '').trim() || null;
            } catch (e) {
                console.error("AI Error", e);
                return null;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
             attemptAutoLoad('deck_config.json');
        });

        /* --- Search & Feedback Logic --- */
        const btnFeedback = document.getElementById('btn-feedback');
        if (btnFeedback) {
            btnFeedback.addEventListener('click', () => {
                const subject = encodeURIComponent('„ÄêÂç°ÁªÑËØçÊù°ÂèçÈ¶à/Ê∑ªÂä†„Äë');
                const body = encodeURIComponent('1) ËØçÊù°ÂêçÔºö\n2) ÊèèËø∞Ôºö\n3) ÂèçÈ¶à‰∫∫/‰ΩúËÄÖÔºö');
                location.href = `mailto:zawinzala@outlook.com?subject=${subject}&body=${body}`;
            });
        }

        const sideSearchBtn = document.getElementById('sideSearchBtn');
        const searchPanel = document.getElementById('searchPanel');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const closeSearch = document.getElementById('closeSearch');

        function toggleSearchPanel(show) {
            if (show === undefined) show = !searchPanel.classList.contains('active');
            searchPanel.classList.toggle('active', show);
            searchPanel.setAttribute('aria-hidden', String(!show));
            if (show) { searchInput.focus(); searchInput.select(); } 
            else { searchInput.value = ''; searchResults.innerHTML = ''; }
        }
        sideSearchBtn.addEventListener('click', () => toggleSearchPanel(true));
        closeSearch.addEventListener('click', () => toggleSearchPanel(false));

        function debounce(fn, wait = 180) {
            let t;
            return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
        }

        // Updated for Requirement 2: Show Author in Search Results
        function performSearch(q) {
            searchResults.innerHTML = '';
            if (!q || !POOLS) {
                searchResults.innerHTML = '<div style="color:#666;text-align:center;padding:10px;">ËØ∑ËæìÂÖ•...</div>';
                return;
            }
            const qq = q.trim().toLowerCase();
            const poolList = [
                ...(POOLS.buffs || []),
                ...(POOLS.debuffs || []),
                ...UNIT_CATEGORIES.flatMap(cat => (POOLS.byCategory[cat] || []))
            ];

            const found = poolList.filter(item => {
                const t = (item.title || '').toLowerCase();
                const c = (item.content || '').toLowerCase();
                const a = (item.author || '').toLowerCase();
                return t.includes(qq) || c.includes(qq) || a.includes(qq);
            });

            if (found.length === 0) {
                searchResults.innerHTML = '<div style="color:#666;text-align:center;">Êó†ÁªìÊûú</div>';
                return;
            }

            found.slice(0, 50).forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-result';
                div.innerHTML = `
                    <div style="font-weight:700; color:#e0e0e0;">${item.title}</div>
                    <div style="font-size:0.75rem; color:#888;">${item.content}</div>
                    <div style="font-size:0.7rem; color:var(--gold); text-align:right; margin-top:2px;">¬© ${item.author || 'Êú™Áü•'}</div>
                `;
                div.addEventListener('click', async () => {
                     try {
                        await navigator.clipboard.writeText(`${item.title}\n${item.content}`);
                        div.style.background = 'var(--text-highlight)';
                        div.style.color = '#000';
                        setTimeout(() => { div.style.background = ''; div.style.color = ''; }, 300);
                     } catch(e){}
                });
                searchResults.appendChild(div);
            });
        }

        searchInput.addEventListener('input', debounce((e) => performSearch(e.target.value), 160));
        searchInput.addEventListener('keydown', (e) => { if (e.key === 'Escape') toggleSearchPanel(false); });

    </script>
</body>
</html>

